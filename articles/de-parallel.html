<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Disposition Effect in Parallel • dispositionEffect</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Disposition Effect in Parallel">
<meta property="og:description" content="dispositionEffect">
<meta property="og:image" content="https://marcozanotti.github.io/dispositionEffect/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dispositionEffect</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/de-analysis.html">The Analysis of Disposition Effect</a>
    </li>
    <li>
      <a href="../articles/de-parallel.html">Disposition Effect in Parallel</a>
    </li>
    <li>
      <a href="../articles/de-timeseries.html">Time Series Disposition Effect</a>
    </li>
    <li>
      <a href="../articles/getting-started.html">Getting Started</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/marcozanotti/dispositionEffect/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="de-parallel_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Disposition Effect in Parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/marcozanotti/dispositionEffect/blob/master/vignettes/de-parallel.Rmd"><code>vignettes/de-parallel.Rmd</code></a></small>
      <div class="hidden name"><code>de-parallel.Rmd</code></div>

    </div>

    
    
<p> </p>
<div id="package-loading" class="section level1">
<h1 class="hasAnchor">
<a href="#package-loading" class="anchor"></a>Package loading</h1>
<p>To load the package simply use the usual <code>library</code> function.<br>
This tutorial requires also some well-known packages that allows for parallel computations in R.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marcozanotti.github.io/dispositionEffect">dispositionEffect</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/future">future</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/bench">bench</a></span><span class="op">)</span></code></pre></div>
<p> </p>
</div>
<div id="data" class="section level1">
<h1 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h1>
<p>The disposition effect analysis is performed on two fundamental types of data frames:</p>
<ul>
<li><p>portfolio transactions, that is all the financial transactions an investor did during a specific period of time. A single transaction is made up of 6 features: the investor id, the asset id, the type of the transaction (it can be a buy or a sell), the traded quantity, the traded price, and the datetime.</p></li>
<li><p>market prices, that is the prices found on the stock markets for each traded asset and each transaction datetimes.</p></li>
</ul>
<p> </p>
</div>
<div id="the-problem" class="section level1">
<h1 class="hasAnchor">
<a href="#the-problem" class="anchor"></a>The Problem</h1>
<p>Usually, investor’s transactions datasets may be huge in size. Moreover, the dataset of market prices may grow exponentially since it has to contain the market prices for each traded asset on each trading datetime.</p>
<p>This may cause the computation of gains and losses through the main interface of the package (<code>portfolio_compute</code>) to take few minutes in order to produce the output data frame.</p>
<p>This computational inefficiency is particularly due to the size of the market price dataset, since for every transaction we need to look for the closest available market price at that datetime for each asset.</p>
<p>For this reason, we used few parallel methodologies to improve the computation time on large datasets.</p>
<p> </p>
</div>
<div id="the-solution-parallelization" class="section level1">
<h1 class="hasAnchor">
<a href="#the-solution-parallelization" class="anchor"></a>The Solution: Parallelization</h1>
<div id="parallel-porfolio_compute" class="section level2">
<h2 class="hasAnchor">
<a href="#parallel-porfolio_compute" class="anchor"></a>1) Parallel <code>porfolio_compute</code>
</h2>
<p>Usually, you may want to apply the computations on many different investors. To do that one can simply build a function that loops on a list containing the transactions portfolios. The first solution to this problem is to develop a parallel version of <code>portfolio_compute</code> that allows to compute results on many investors in parallel, taking advantage of two very useful R packages: <a href="https://cran.r-project.org/web/packages/future/index.html"><code>future</code></a> and <a href="https://cran.r-project.org/web/packages/furrr/index.html"><code>furrr</code></a>.</p>
<p>A very simple version of the function would look like this.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">portfolio_compute_parallel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">portfolio_transactions</span>, <span class="va">market_prices</span>, <span class="va">plan</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>

    <span class="va">investors_id</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">portfolio_transactions</span>, <span class="op">~</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">.</span>, <span class="st">"investor"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
    <span class="va">portfolio_compute_safe</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/safely.html">safely</a></span><span class="op">(</span><span class="va">portfolio_compute</span><span class="op">)</span>

    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">plan</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">ncores</span> <span class="op">&lt;-</span> <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/future/man/re-exports.html">availableCores</a></span><span class="op">(</span><span class="op">)</span>
      <span class="co"># if there are more than 2 cores than use parallel computing</span>
      <span class="co"># otherwise use sequential computing</span>
      <span class="co"># RULE: be polite, always leave at least 1 free core</span>
      <span class="kw">if</span> <span class="op">(</span><span class="op">(</span><span class="va">ncores</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
          <span class="va">new_plan</span> <span class="op">&lt;-</span> <span class="st">"multisession"</span> <span class="co"># since I am testing on Windows</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="va">new_plan</span> <span class="op">&lt;-</span> <span class="st">"sequential"</span>
      <span class="op">}</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="va">new_plan</span> <span class="op">&lt;-</span> <span class="va">plan</span>
    <span class="op">}</span>
    
    <span class="va">old_plan</span> <span class="op">&lt;-</span> <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span>strategy <span class="op">=</span> <span class="va">new_plan</span><span class="op">)</span>

    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map.html">future_map</a></span><span class="op">(</span>
        <span class="va">portfolio_transactions</span>,
        <span class="va">portfolio_compute_safe</span>,
        <span class="va">market_prices</span>,
        <span class="va">...</span><span class="op">)</span>

    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/transpose.html">transpose</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">$</span><span class="va">result</span>
    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">investors_id</span>

    <span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/future/man/plan.html">plan</a></span><span class="op">(</span><span class="va">old_plan</span><span class="op">)</span> <span class="co"># set back the old plan</span>

    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
<p>This way you simply need to store all the different investor’s portfolios of transactions in a list and pass it to <code>portfolio_compute_parallel</code> as first argument.</p>
<p>Now let’s try it on the <code>DEanalysis</code> dataset to see if there is any computational improvement.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">trx</span> <span class="op">&lt;-</span> <span class="va">DEanalysis</span><span class="op">$</span><span class="va">transactions</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">investor</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">mkt</span> <span class="op">&lt;-</span> <span class="va">DEanalysis</span><span class="op">$</span><span class="va">marketprices</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="st">"sequential"</span> <span class="op">=</span> <span class="fu">portfolio_compute_parallel</span><span class="op">(</span><span class="va">trx</span>, <span class="va">mkt</span>, plan <span class="op">=</span> <span class="st">"sequential"</span><span class="op">)</span>,
  <span class="st">"parallel"</span> <span class="op">=</span> <span class="fu">portfolio_compute_parallel</span><span class="op">(</span><span class="va">trx</span>, <span class="va">mkt</span>, plan <span class="op">=</span> <span class="st">"multisession"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">res</span><span class="op">$</span><span class="va">expression</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sequential"</span>, <span class="st">"parallel"</span><span class="op">)</span>
<span class="va">res</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span></code></pre></div>
<p><img src="figures/de-parallel-bench1.PNG" width="100%" style="display: block; margin: auto;"></p>
<p>As you can see, the benefits of parallel code are clear even on this small sample dataset.</p>
<p> </p>
</div>
<div id="separate-files" class="section level2">
<h2 class="hasAnchor">
<a href="#separate-files" class="anchor"></a>2) Separate files</h2>
<p>Although the first solution may be enough with many small investors, when things get bigger it may be better to phisically separate transactions and market prices for each investor.</p>
<p>This way, a single <code>.RData</code> that contains both the transactions and the market prices for a single investor is created. Once this process is finished, one can simply perform the computations with the usual <code>portfolio_compute</code> loading the needed file sequentially or in parallel by means of the <a href="https://cran.r-project.org/web/packages/foreach/foreach.pdf"><code>foreach</code></a> package.</p>
<p>First let’s store every investor’s datasets into its own file. To do this we can make use of the <code>dispositionEffect:::generate_data</code> internal function. In this way, we are able also to optimize the market price dataset, since for each investor we can save only the market prices of his traded assets for that specific period of trading.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="fu">foreach</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">trx</span><span class="op">)</span>, .errorhandling <span class="op">=</span> <span class="st">"pass"</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span>

  <span class="va">transactions</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">trx</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">datetime</span><span class="op">)</span>
  <span class="va">mrkt_prices</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span>
    <span class="va">mkt</span>, 
    <span class="va">asset</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">transactions</span><span class="op">$</span><span class="va">asset</span><span class="op">)</span> <span class="op">&amp;</span> 
      <span class="va">datetime</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">transactions</span><span class="op">$</span><span class="va">datetime</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">dispositionEffect</span><span class="fu">:::</span><span class="fu"><a href="../reference/manipulate_initial_data.html">generate_data</a></span><span class="op">(</span><span class="va">transactions</span>, <span class="va">mrkt_prices</span>, subset <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">nm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"INV"</span>, <span class="va">i</span>, <span class="st">".RData"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">df</span>, file <span class="op">=</span> <span class="va">nm</span><span class="op">)</span>

<span class="op">}</span>
<span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></code></pre></div>
<p>Now, we can build the function to perform computations loading each single file sequentially or in parallel.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">portfolio_compute_onfiles</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">files</span>, <span class="va">plan</span> <span class="op">=</span> <span class="st">"sequential"</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="va">plan</span> <span class="op">==</span> <span class="st">"sequential"</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="va">res_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="co"># load the file</span>
      <span class="va">tmp_res</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span>
        <span class="fu">dispositionEffect</span><span class="fu">::</span><span class="fu"><a href="../reference/portfolio_compute.html">portfolio_compute</a></span><span class="op">(</span>
          portfolio_transactions <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">transactions</span>,
          market_prices <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">marketprices</span>
        <span class="op">)</span>,
        error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="st">"Error"</span>
      <span class="op">)</span>
      <span class="va">res_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmp_res</span> <span class="co"># save results</span>
      <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">tmp_res</span><span class="op">)</span>
    <span class="op">}</span>
    
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    
    <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
    <span class="va">res_list</span> <span class="op">&lt;-</span>
      <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span>, .errorhandling <span class="op">=</span> <span class="st">"pass"</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span>
        <span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="va">files</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="co"># load the file</span>
        <span class="va">tmp_res</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span>
          <span class="fu">dispositionEffect</span><span class="fu">::</span><span class="fu"><a href="../reference/portfolio_compute.html">portfolio_compute</a></span><span class="op">(</span>
            portfolio_transactions <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">transactions</span>,
            market_prices <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">marketprices</span>
          <span class="op">)</span>,
          error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="st">"Error"</span>
        <span class="op">)</span>
      <span class="op">}</span>
    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
    
  <span class="op">}</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res_list</span><span class="op">)</span>
    
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">".RData"</span><span class="op">)</span> <span class="co"># list all single .RData</span>

<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bench/man/mark.html">mark</a></span><span class="op">(</span>
  <span class="fu">portfolio_compute_onfiles</span><span class="op">(</span><span class="va">files</span>, plan <span class="op">=</span> <span class="st">"sequential"</span><span class="op">)</span>,
  <span class="fu">portfolio_compute_onfiles</span><span class="op">(</span><span class="va">files</span>, plan <span class="op">=</span> <span class="st">"multisession"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">res</span><span class="op">$</span><span class="va">expression</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sequential"</span>, <span class="st">"parallel"</span><span class="op">)</span>
<span class="va">res</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span></code></pre></div>
<p><img src="figures/de-parallel-bench2.PNG" width="100%" style="display: block; margin: auto;"></p>
<p> </p>
</div>
</div>
<div id="conclusions" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h1>
<p>As expected, parallel computation coupled with load in memory small portion of datasets is the optimal solution.</p>
<p>Moreover, sometimes a little gain in computation time can be optained by setting the <code>exact_market_prices</code> argument of <code>portfolio_compute</code> equal to TRUE. This way, the closest market price search is performed on the very same transaction datetime, but it requires that the market price dataset contains all the prices for each asset at each single transaction datetime.</p>
<p> </p>
<p> </p>
<hr>
<p><em>This tests have been performed on a 4 core, 8GB RAM, Windows machine</em></p>
<pre><code>#&gt;                _                           
#&gt; platform       x86_64-apple-darwin17.0     
#&gt; arch           x86_64                      
#&gt; os             darwin17.0                  
#&gt; system         x86_64, darwin17.0          
#&gt; status                                     
#&gt; major          4                           
#&gt; minor          0.5                         
#&gt; year           2021                        
#&gt; month          03                          
#&gt; day            31                          
#&gt; svn rev        80133                       
#&gt; language       R                           
#&gt; version.string R version 4.0.5 (2021-03-31)
#&gt; nickname       Shake and Throw</code></pre>
<p> </p>
<p>For more tutorials on disposition effect visit <a href="https://marcozanotti.github.io/dispositionEffect">dispositionEffect</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lorenzo Mazzucchelli, Marco Zanotti.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
